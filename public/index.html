<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Tutor Bíblico Tito</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
</head>
<body style="font-family: Arial, sans-serif; max-width: 650px; margin: auto; padding: 2rem; background-color: #fef9f4; color: #2d3436;">

  <!-- Presentación de Tito -->
  <div style="display: flex; align-items: center; background-color: #f5f8fa; border-radius: 12px; padding: 20px; box-shadow: 0px 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px;">
    <img src="tito.jpg" alt="Tutor Tito" style="width: 120px; border-radius: 50%; margin-right: 20px;">
    <p style="font-size: 1.2rem; font-weight: 500;">Hola soy <strong>Tito</strong>, tu tutor virtual. Estoy para acompañarte en tu aprendizaje bíblico.</p>
  </div>

  <h1 style="font-size: 1.8rem; font-weight: bold; color: #2980b9;">📖 Tutor Bíblico IA</h1>

  <!-- Entrada de texto -->
  <textarea id="input" rows="4" style="width: 100%; padding: 10px; font-size: 1rem; border-radius: 8px; border: 1px solid #ccc;" placeholder="Escribe tu pregunta aquí..."></textarea>
  <br><br>

  <!-- Botones -->
  <button onclick="enviarMensaje()" style="background-color: #3498db; color: white; padding: 10px 20px; border: none; border-radius: 8px; font-size: 1rem; cursor: pointer;">Enviar pregunta</button>

  <button onclick="reconocerVoz()" style="background-color: #2ecc71; color: white; padding: 10px 20px; border: none; border-radius: 8px; font-size: 1rem; margin-left: 10px; cursor: pointer;">🎤 Dictar</button>

  <!-- ✅ Botón para detener voz -->
  <button onclick="detenerVoz()" style="background-color: #e74c3c; color: white; padding: 10px 20px; border: none; border-radius: 8px; font-size: 1rem; margin-top: 10px; cursor: pointer;">
    🛑 Detener voz
  </button>

  <!-- Indicador de carga -->
  <p id="cargando" style="display:none; font-style: italic; color: #888;">⏳ Tito está pensando...</p>

  <!-- Área de respuesta -->
  <h3>Respuesta:</h3>
  <div id="respuesta" style="white-space: pre-wrap; background: #f3f3f3; padding: 1rem; border-radius: 5px;"></div>

  <!-- Script -->
  <script>
    async function enviarMensaje() {
      const mensaje = document.getElementById('input').value;
      const respuestaDiv = document.getElementById('respuesta');
      const cargando = document.getElementById('cargando');

      cargando.style.display = 'block';
      respuestaDiv.textContent = '';
      detenerVoz(); // 🛑 Detiene si Tito está hablando

      try {
        const res = await fetch('/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: mensaje })
        });

        const data = await res.json();

        const respuesta = data.reply;
        const emoji = clasificarEmoji(respuesta);
        const final = `${emoji} ${respuesta}`;
        respuestaDiv.textContent = final;

        hablar(final); // Tito habla la respuesta

      } catch (error) {
        respuestaDiv.textContent = '⚠️ Error al conectar con el servidor.';
        console.error(error);
      } finally {
        cargando.style.display = 'none';
      }
    }

    // 🎤 Dictado por voz
    function reconocerVoz() {
      if (!('webkitSpeechRecognition' in window)) {
        alert('Tu navegador no soporta reconocimiento de voz.');
        return;
      }

      const recognition = new webkitSpeechRecognition();
      recognition.lang = 'es-PE';

      recognition.onstart = () => {
        document.getElementById('input').placeholder = '🎙️ Escuchando...';
      };

      recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        document.getElementById('input').value = transcript;
        document.getElementById('input').placeholder = 'Escribe tu pregunta aquí...';
      };

      recognition.onerror = () => {
        alert('Error al reconocer la voz.');
      };

      recognition.start();
    }

    // 🗣️ Voz de Tito
    function hablar(texto) {
      speechSynthesis.cancel(); // Detener cualquier voz previa
      const mensaje = new SpeechSynthesisUtterance(texto);
      mensaje.lang = 'es-PE';
      speechSynthesis.speak(mensaje);
    }

    // 🛑 Detener voz manualmente
    function detenerVoz() {
      speechSynthesis.cancel();
    }

    // 😊 Emoji según el tono
    function clasificarEmoji(texto) {
      const lower = texto.toLowerCase();
      if (lower.includes("bien") || lower.includes("alegría") || lower.includes("esperanza")) return "😊";
      if (lower.includes("no se puede") || lower.includes("triste") || lower.includes("dificultad")) return "😔";
      if (lower.includes("advertencia") || lower.includes("cuidado")) return "⚠️";
      if (lower.includes("cristo") || lower.includes("dios")) return "✝️";
      return "💬";
    }
  </script>

</body>
</html>


